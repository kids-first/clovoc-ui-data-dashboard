---
title: "CLOVoc Intermediate ETL Pipeline"
output: html_document
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(dplyr)

ParsePatientID <- function(x) {
    return(unlist(strsplit(x, "/"))[2])
}

grab_fhir <- function(resource_name, desc_cols, url, cookie, format, tags = NULL) {
  # Create parameters for resource request, with or without tags
  if (!is.null(tags)) {
    parameters <- c("_count" = "100", "_tags" = tags)
  } else {
    parameters <- c("_count" = "100")
  }
  
  # Build a request URL for resource
  resource_request <- fhircrackr::fhir_url(
    url = fhir_api_url,
    resource = resource_name,
    parameters = parameters
  )
  
  # Download bundles of resources
  resource_bundles <- fhircrackr::fhir_search(
    request = resource_request,
    add_headers = cookie,
    verbose = 2
  )
  
  # Define a resource table description
  resource_description <- fhircrackr::fhir_table_description(
    resource = resource_name,
    cols = desc_cols,
    sep = " ~ ",
    brackets = c("<<", ">>"),
    rm_empty_cols = FALSE,
    format = format
  )
  
  # Flatten resources
  data <- fhircrackr::fhir_crack(
    bundles = resource_bundles, design = resource_description, verbose = 2
  )
  
  # Return dataset
  data
}

clean_dataset <- function(data) {
  # Remove indices
  data <- fhircrackr::fhir_rm_indices(data, brackets = c("<<", ">>"))
  
  # Extract patient IDs
  data$"Patient ID" <- unlist(lapply(data$"Patient ID", ParsePatientID))
}

join_patient_data <- function(data, patients) {
  # Right-join patient_ids and conditions on Patient ID
  data <- merge(
    patient_ids,
    data,
    by.x = "Patient ID",
    by.y = "Patient ID",
    all.y = TRUE
  )

  # Drop columns
  data <- within(data, rm("Patient ID"))
}
```

## Kids First Dataset

Pull Kids First data from CLOVoc endpoint:

```{r kf-auth}
# Get FHIR credentails
fhir_api_url <- Sys.getenv("CLOVOC_BASE_URL")
fhir_api_cookie <- Sys.getenv("CLOVOC_FHIR_API_COOKIE")

# Define headers
cookies <- c(Cookie = fhir_api_cookie)
```

```{r kf-group}
# /Group
# Description Columns
resource_columns <- c("ResearchStudy Identifier" = "meta/tag/code",
                      "Group Identifier" = "identifier/value",
                      "Patient ID" = "member/entity/reference")

# Grab Group resources from FHIR API endpoint
groups <- grab_fhir(resource_name = "Group",
                    desc_cols = resource_columns,
                    url = fhir_api_url,
                    cookie = cookies,
                    format = "compact")

# Melt columns
groups <- fhircrackr::fhir_melt(
    groups, columns = c("Patient ID"),
    sep = " ~ ",
    brackets = c("<<", ">>"),
    all_columns = TRUE
)

groups <- clean_dataset(groups)

# Drop columns
groups <- within(groups, rm("resource_identifier"))
```

```{r kf-patient}
# /Patient
# Description Columns
resource_columns <- c("Patient ID" = "id",
                      "Patient Identifier" = "identifier/value",
                      "Race ~ Ethnicity" = "extension/extension/valueString",
                      "Gender" = "gender")

# Grab Patient resources from FHIR API endpoint
patients <- grab_fhir(resource_name = "Patient",
                      desc_cols = resource_columns,
                      url = fhir_api_url,
                      cookie = cookies,
                      format = "wide")

# Change column names
setnames(
    patients,
    old = c(
        "<<1>>Patient ID",
        "<<1.1>>Patient Identifier",
        "<<1.1.1>>Race ~ Ethnicity",
        "<<2.1.1>>Race ~ Ethnicity",
        "<<1>>Gender"
    ),
    new = c("Patient ID", "Patient Identifier", "Race", "Ethnicity", "Gender")
)

# Cache Patient IDs and Identifiers
patient_ids <- patients[, c("Patient ID", "Patient Identifier")]

# Right-join groups and patients on Patient ID
patients <- join_patient_data(patients, groups)
```

```{r kf-condition}
# /Condition
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
                      "Clinical Status" = "clinicalStatus/text",
                      "Verification Status" = "verificationStatus/text",
                      "Condition Name" = "code/text",
                      "Condition Ontology URI" = "code/coding/system",
                      "Condition Code" = "code/coding/code",
                      "Body Site Name" = "bodySite/text",
                      "Body Site Ontology URI" = "bodySite/coding/system",
                      "Body Site Code" = "bodySite/coding/code")

# Grab Condition resources from FHIR API endpoint
conditions <- grab_fhir(resource_name = "Condition",
                        desc_cols = resource_columns,
                        url = fhir_api_url,
                        cookie = cookies,
                        format = "compact")

# Remove indices
conditions <- clean_dataset(conditions)

# Right-join patient_ids and conditions on Patient ID
conditions <- join_patient_data(patient_ids, conditions)
```

```{r kf-specimen}
# /Specimen
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
        "Specimen Identifier" = "identifier/value",
        "Specimen Status" = "status",
        "Specimen Type Name" = "type/text",
        "Specimen Type Ontology URI" = "type/coding/system",
        "Specimen Type Code" = "type/coding/code",
        "Body Site Name" = "collection/bodySite/text",
        "Body Site Ontology URI" = "collection/bodySite/coding/system",
        "Body Site Code" = "collection/bodySite/coding/code")

# Grab Specimen resources from FHIR API endpoint
specimens <- grab_fhir(resource_name = "Specimen",
                       desc_cols = resource_columns,
                       url = fhir_api_url,
                       cookie = cookies,
                       format = "compact")

specimens <- clean_dataset(specimens)

# Right-join patient_ids and specimens on Patient ID
specimens <- join_patient_data(patient_ids, specimens)
```

```{r kf-document}
# /DocumentReference
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
                      "DocumentReference Status" = "status",
                      "Document Status" = "docStatus",
                      "Document Type" = "type/text",
                      "Experiment Strategy " = "_experiment_strategy",
                      "Data Category" = "category/coding/display",
                      "URL" = "content/attachment/url")

# Grab DocumentReference resources from FHIR API endpoint
document_references <- grab_fhir(resource_name = "DocumentReference",
                                 desc_cols = resource_columns,
                                 url = fhir_api_url,
                                 cookie = cookies,
                                 format = "compact")

document_references <- clean_dataset(document_references)

# Right-join patient_ids and document_references on Patient ID
document_references <- join_patient_data(patient_ids, document_references)
```

```{r kf-cache}
# Cache data frames
clovoc_api_fhir_service <- list(
    "Patient" = patients,
    "Condition" = conditions,
    "Specimen" = specimens,
    "DocumentReference" = document_references
)
```

## Include Dataset

Pull Include data:

```{r include-auth}
# Get FHIR credentials
fhir_api_url <- Sys.getenv("INCLUDE_BASE_URL")
fhir_api_cookie <- Sys.getenv("INCLUDE_FHIR_API_COOKIE")

# Define parameters and headers
tags <- c("DS360-CHD", "DS-COG-ALL", "DS-PCGC")
tags <- paste(tags, collapse = ",")
cookies <- c(Cookie = fhir_api_cookie)
```

```{r include-group}
# /Group
# Description Columns
resource_columns <- c("ResearchStudy Identifier" = "meta/tag/code",
                      "Group Identifier System" = "identifier/system",
                      "Group Identifier Value" = "identifier/value",
                      "Patient ID" = "member/entity/reference")

# Grab Group resources from FHIR API endpoint
groups <- grab_fhir(resource_name = "Group",
                    desc_cols = resource_columns,
                    url = fhir_api_url,
                    cookie = cookies,
                    format = "compact",
                    tags = tags)

# Melt columns
groups <- fhircrackr::fhir_melt(
    groups,
    columns = c(
        "Group Identifier System",
        "Group Identifier Value"
    ),
    sep = " ~ ",
    brackets = c("<<", ">>"),
    all_columns = TRUE
)
groups <- fhircrackr::fhir_melt(
    groups, columns = c("Patient ID"),
    sep = " ~ ",
    brackets = c("<<", ">>"),
    all_columns = TRUE
)

groups <- clean_dataset(groups)

# Filter rows
group_filter <- "https://kf-api-dataservice.kidsfirstdrc.org/families/"
groups <- groups[groups$"Group Identifier System" != group_filter, ]

# Drop columns
groups <- within(groups, rm("Group Identifier System", "resource_identifier"))

# Change column names
setnames(
    groups, old = c("Group Identifier Value"), new = c("Group Identifier")
)
```

```{r include-patient}
# /Patient
# Description Columns
resource_columns <- c("Patient ID" = "id",
                      "Patient Identifier Value" = "identifier/value",
                      "Race ~ Ethnicity" = "extension/extension/valueString",
                      "Gender" = "gender")

# Grab Patient resources from FHIR API endpoint
patients <- grab_fhir(resource_name = "Patient",
                      desc_cols = resource_columns,
                      url = fhir_api_url,
                      cookie = cookies,
                      format = "wide",
                      tags = tags)

# Drop columns
patients <- within(patients, rm("<<1.1>>Patient Identifier Value"))

# Change column names
setnames(
    patients,
    old = c(
        "<<1>>Patient ID",
        "<<2.1>>Patient Identifier Value",
        "<<1.1.1>>Race ~ Ethnicity",
        "<<2.1.1>>Race ~ Ethnicity",
        "<<1>>Gender"
    ),
    new = c("Patient ID", "Patient Identifier", "Race", "Ethnicity", "Gender")
)

# Cache Patient IDs and Identifiers
patient_ids <- patients[, c("Patient ID", "Patient Identifier")]

# Right-join groups and patients on Patient ID
patients <- join_patient_data(patients, groups)
```

```{r include-condition}
# /Condition
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
        "Clinical Status" = "clinicalStatus/text",
        "Verification Status" = "verificationStatus/text",
        "Condition Name" = "code/text",
        "Condition Ontology URI" = "code/coding/system",
        "Condition Code" = "code/coding/code",
        "Body Site Name" = "bodySite/text",
        "Body Site Ontology URI" = "bodySite/coding/system",
        "Body Site Code" = "bodySite/coding/code")

# Grab Condition resources from FHIR API endpoint
conditions <- grab_fhir(resource_name = "Condition",
                        desc_cols = resource_columns,
                        url = fhir_api_url,
                        cookie = cookies,
                        format = "compact",
                        tags = tags)

conditions <- clean_dataset(conditions)

conditions <- join_patient_data(patient_ids, conditions)
```

```{r include-specimen}
# /Specimen
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
                      "Specimen Identifier System" = "identifier/system",
                      "Specimen Identifier Value" = "identifier/value",
                      "Specimen Status" = "status",
                      "Specimen Type Name" = "type/text",
                      "Specimen Type Ontology URI" = "type/coding/system",
                      "Specimen Type Code" = "type/coding/code",
                      "Body Site Name" = "collection/bodySite/text",
                      "Body Site Ontology URI" = "collection/bodySite/coding/system",
                      "Body Site Code" = "collection/bodySite/coding/code")

# Grab Specimen resources from FHIR API endpoint
specimens <- grab_fhir(resource_name = "Specimen",
                       desc_cols = resource_columns,
                       url = fhir_api_url,
                       cookie = cookies,
                       format = "wide",
                       tags = tags)

# Change column names
setnames(
    specimens,
    old = c(
        "<<1.1>>Patient ID",
        "<<1.1>>Specimen Identifier Value",
        "<<1>>Specimen Status",
        "<<1.1>>Specimen Type Name",
        "<<1.1.1>>Specimen Type Ontology URI",
        "<<1.1.1>>Specimen Type Code"
    ),
    new = c(
        "Patient ID",
        "Specimen Identifier",
        "Specimen Status",
        "Specimen Type Name",
        "Specimen Type Ontology URI",
        "Specimen Type Code"
    )
)

# Drop columns
specimens <- within(specimens, rm("<<2.1>>Specimen Identifier System",
                                  "<<2.1>>Specimen Identifier Value",
                                  "<<3.1>>Specimen Identifier Value"))

specimens <- clean_dataset(specimens)

# Right-join patient_ids and specimens on Patient ID
specimens <- join_patient_data(patient_ids, specimens)
```

```{r include-document}
# /DocumentReference
# Description Columns
resource_columns <- c("Patient ID" = "subject/reference",
                      "DocumentReference Status" = "status",
                      "Document Status" = "docStatus",
                      "Document Type" = "type/text",
                      "Experiment Strategy ~ Data Category" = "category/coding/display",
                      "URL" = "content/attachment/url")

# Grab DocumentReference resources from FHIR API endpoint
document_refereces <- grab_fhir(resource_name = "DocumentReference",
                                desc_cols = resource_columns,
                                url = fhir_api_url,
                                cookie = cookies,
                                format = "wide",
                                tags = tags)

# Change column names
setnames(
    document_references,
    old = c(
        "<<1.1>>Patient ID",
        "<<1>>DocumentReference Status",
        "<<1>>Document Status",
        "<<1.1>>Document Type",
        "<<1.1.1>>Experiment Strategy ~ Data Category",
        "<<2.1.1>>Experiment Strategy ~ Data Category",
        "<<1.1.1>>URL"
    ),
    new = c(
        "Patient ID",
        "DocumentReference Status",
        "Document Status",
        "Document Type",
        "Experiment Strategy",
        "Data Category",
        "URL"
    )
)

document_references <- clean_dataset(document_references)

# Right-join patient_ids and document_references on Patient ID
document_references <- join_patient_data(document_references)
```

```{r include-cache}
# Cache data frames
include_api_fhir_service <- list(
    "Patient" = patients,
    "Condition" = conditions,
    "Specimen" = specimens,
    "DocumentReference" = document_references
)
```

## Combine Datasets
```{r combine}
dataset <- list(
    "Patient" = bind_rows(
        include_api_fhir_service[["Patient"]],
        clovoc_api_fhir_service[["Patient"]]
    ),
    "Condition" = bind_rows(
        include_api_fhir_service[["Condition"]],
        clovoc_api_fhir_service[["Condition"]]
    ),
    "Specimen" = bind_rows(
        include_api_fhir_service[["Specimen"]],
        clovoc_api_fhir_service[["Specimen"]]
    ),
    "DocumentReference" = bind_rows(
        include_api_fhir_service[["DocumentReference"]],
        clovoc_api_fhir_service[["DocumentReference"]]
    )
)
```

## Post Dataset
```{r post}
board <- pins::board_rsconnect()
board |>
  pins::pin_write(dataset, "clovoc-data-test", type = "rds")
```
